# `py2asm/lib` - The Compiler's Core Logic

This directory contains the heart of the `py2asm` compiler. The Python modules here are responsible for processing the Abstract Syntax Tree (AST) generated from the source Python code and translating its nodes into 6502 assembly instructions.

The compilation process is modular, with different files handling specific aspects of the Python language.

## File Structure and Roles

-   `ast_processor.py`: This is the central dispatcher of the compiler. It contains the main logic for traversing the AST. For each type of node it encounters (e.g., `ast.Assign`, `ast.FunctionDef`, `ast.If`), it calls the appropriate processing function, which may reside in this file or be delegated to a more specialized module. It orchestrates the entire code generation pass.

-   `func_core.py`: This module provides the fundamental building blocks and helper functions used throughout the compiler. Its responsibilities include:
    -   Managing temporary variables.
    -   Generating unique labels for jumps and loops.
    -   Handling low-level memory operations (e.g., copying bytes).
    -   Implementing the core mechanics for stack operations (push/pop) and function prologues/epilogues.

-   `func_expressions.py`: This module is dedicated to translating Python expressions into assembly code. It handles a wide range of operations, such as:
    -   Arithmetic operations (`+`, `-`, `*`, `/`) for both integers and floating-point numbers.
    -   Evaluating constants and variables.
    -   Processing function calls and their arguments.
    -   Type casting (`int()`, `float()`).

-   `func_structures.py`: This module implements the logic for control flow structures. It is responsible for generating the assembly code for:
    -   `if/else` conditional statements.
    -   `for` and `while` loops (as they are implemented).

-   `func_dict.py`: This module specifically handles operations related to Python's `dict` data type. This includes generating code for dictionary creation, assignment (`my_dict[key] = value`), and lookups.

-   `func_strings.py`: This module contains the logic for handling string literals and operations. It works closely with the `print()` built-in function and would be responsible for future features like string concatenation or manipulation.

## Relationship with `routines.py`

While most modules in this directory generate assembly code on the fly, the `routines.py` module serves a special purpose. It contains the compiler's "runtime library" as a collection of hand-written, pre-optimized 6502 assembly code snippets stored as Python strings. These routines implement complex or repetitive tasks, such as:

-   Floating-point arithmetic.
-   Graphics primitives (`draw_line`, `clear_screen`).
-   Printing characters and numbers to the screen.
-   Stack manipulation helpers (`push_word_ax`, `pop_word_to_addr`).

The code generated by the other `lib` modules will often include `JSR` (Jump to Subroutine) instructions that call these pre-written routines. The compiler tracks which routines are used and links only the necessary ones (along with their dependencies) into the final assembly file. This keeps the final program size as small as possible.
